<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bemobi - IFrame Checkout</title>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .iframe-container {
        height: 100vh;
        padding: 20px;
      }
      .responsive-iframe {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body>
    <div class="container-fluid iframe-container">
      <div class="row h-100">
        <div class="col-12">
          <!--
          O IFrame deve primeiro chamar a URL raiz, para que a ativação do dispositivo seja
          verificada e as pendências resolvidas.

          Se a ativação ocorrer com sucesso, o IFrame receberá a mensagem DEVICE_ACTIVATION_OK.
          Caso contrário, o IFrame receberá a mensagem DEVICE_ACTIVATION_ERROR, e deverá encerrar
          a operação, acionando o suporte para obter credenciais para o totem.

          Após a ativação com sucesso, a aplicação iniciará automaticamente a resolução de pendências,
          e ao final enviará a mensagem SITEF_ISSUE_RESOLUTION_OK. Caso haja falha na resolução de pendências,
          a mensagem enviada será SITEF_ISSUE_RESOLUTION_ERROR, e o IFrame deverá encerrar a operação, acionando o suporte.

          -->
          <iframe id="testIframe" src="" class="responsive-iframe"></iframe>
        </div>
      </div>
    </div>

    <!-- Bootstrap 5 JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let sessionToken = undefined;
      // URL base da aplicação
      //const BASE_URL = "http://localhost:3000";
      const BASE_URL = "https://totem-bemobi-web.vercel.app";

      // Funções para manipulação de cookies
      function setCookie(name, value, days = 30) {
        const expires = new Date();
        expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
        document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Strict`;
      }

      function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(";");
        for (let i = 0; i < ca.length; i++) {
          let c = ca[i];
          while (c.charAt(0) === " ") c = c.substring(1, c.length);
          if (c.indexOf(nameEQ) === 0)
            return c.substring(nameEQ.length, c.length);
        }
        return null;
      }

      function deleteCookie(name) {
        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;SameSite=Strict`;
      }

      // Definir a URL do iframe quando a página carregar
      window.onload = function () {
        sessionToken = getCookie("sessionToken");

        if (sessionToken) {
          // Se o sessionToken existe, redirecionar para a URL com o token
          document.getElementById("testIframe").src =
            BASE_URL + "/bemobi/" + sessionToken + "/device";
          console.log(
            "Session Token encontrado, redirecionando para:",
            BASE_URL + "/bemobi/" + sessionToken + "/device"
          );
        } else {
          // Se não existe sessionToken, redirecionar para ativação
          document.getElementById("testIframe").src =
            BASE_URL + "/activation/serial";
          console.log(
            "Session Token não encontrado, redirecionando para ativação:",
            BASE_URL + "/activation/serial"
          );
        }
      };

      // Função para enviar mensagem para o iframe
      function enviarDadosParaListagem() {
        const iframe = document.querySelector("iframe");
        const mensagem = {
          event: "SELECTED_INVOICES",
          ids: [""],
          documentNumber: "01205793321",
          installationCode: "3018353422",
          contractCode: "3019024597",
          protocol: "20251003000001",
        };
        iframe.contentWindow.postMessage(mensagem, "*");
      }

      // Listener para receber mensagens do iframe
      window.onmessage = function (e) {
        if (e.origin === BASE_URL) {
          console.log("Mensagem recebida no iframe:", e.data);
        }
        if (e.data.event != undefined) {
          /*
           * Ao receber a mensagem DEVICE_ACTIVATION_OK, será recebido o Session Token, que deve ser armazenado em um cookie do navegador
           * ou em algum outro local para ser utilizado nas próximas requisições. Renove-o com frequencia para que não expire.
           * Caso seja perdido, será necessário ativar novamente o dispositivo.
           */
          if (e.data.event == "DEVICE_ACTIVATION_OK") {
            console.log(
              "Dispositivo ativado com sucesso. Session Token: ",
              e.data.sessionToken
            );

            // Salvar o sessionToken em um cookie
            if (e.data.sessionToken) {
              setCookie("sessionToken", e.data.sessionToken, 30); // Cookie válido por 30 dias
              console.log("Session Token salvo em cookie com sucesso!");
              document.getElementById("testIframe").src =
                BASE_URL + "/bemobi/" + e.data.sessionToken + "/device";
            } else {
              console.warn(
                "Session Token não foi recebido na mensagem DEVICE_ACTIVATION_OK"
              );
            }
          }

          /*
           * Ao receber a mensagem DEVICE_ACTIVATION_FAILED, o sessionToken deve ser removido do cookie
           * pois a ativação falhou e o token não é mais válido.
           */
          if (e.data.event == "DEVICE_ACTIVATION_FAILED") {
            console.log(
              "Falha na ativação do dispositivo. Removendo sessionToken do cookie."
            );
            deleteCookie("sessionToken");
            console.log("Session Token removido do cookie com sucesso!");
          }

          /*
           * Ao receber a mensagem SITEF_ISSUE_RESOLUTION_OK, a aplicação pode capturar os dados que achar necessário,
           * direcionando para o checkout Bemobi quando entender necessário.
           */
          if (e.data.event == "SITEF_ISSUE_RESOLUTION_OK") {
            document.getElementById("testIframe").src =
              BASE_URL + "/bemobi/" + sessionToken + "/light";
          }
          /*
           * Aguarde este evento para enviar a mensagem com os dados da conta selecionada para consulta.
           */
          if (e.data.event == "PAGE_LOADED") {
            setTimeout(enviarDadosParaListagem, 1000); // Aguarda 1 segundo para garantir que o iframe carregou
          }

          /*
           * Quando este evento for enviado, a aplicação host deve remover qualquer ação que um usuário possa usar para sair da tela.
           * Deve aguardar o evento PAYMENT_SUCCESS ou PAYMENT_ERROR para liberar tais ações novamente.
           */
          if (e.data.event == "PAYMENT_IN_PROGRESS") {
            console.log("Pagamento em andamento...");
          }

          /*
           * Ao receber este evento, a aplicação host pode liberar as ações que um usuário poderia usar para sair da tela.
           * O pagamento foi finalizado com sucesso, com as informações da transação disponíveis no objeto transaction.
           */
          if (e.data.event == "PAYMENT_OK") {
            console.log(
              "Pagamento finalizado com sucesso!!! Dados da transação: ",
              e.data.transaction
            );
          }

          /*
           * Ao receber este evento, a aplicação host pode liberar as ações que um usuário poderia usar para sair da tela.
           * O pagamento ainda poderá ser retentado dentro do IFrame
           * O pagamento foi finalizado com falha na transação.
           */
          if (e.data.event == "PAYMENT_ERROR") {
            console.log("Pagamento finalizado com falha na transação. Dados da transação: ", e.data.error);
            //document.getElementById("testIframe").src = BASE_URL + "/bemobi/" + sessionToken + "/light";;
          }

          /*
           * Ao receber este evento, a aplicação host pode liberar as ações que um usuário poderia usar para sair da tela.
           * O pagamento foi finalizado com falha na transação.
           */
           if (e.data.event == "PAYMENT_CANCELLED") {
            console.log("Pagamento Cancelado: ", e.data.error);
            document.getElementById("testIframe").src = BASE_URL + "/bemobi/" + sessionToken + "/device";;
          }
          
          /*
           * Ao receber este evento, a aplicação host deverá retornar à tela inicial.
           */
           if (e.data.event == "PAYMENT_TIMEOUT") {
            document.getElementById("testIframe").src = BASE_URL + "/bemobi/" + sessionToken + "/device";;
          }
        }
      };
    </script>
  </body>
</html>
