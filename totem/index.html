<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Informe o Contrato</title>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      /* Apenas estilos mínimos necessários */
      .keypad-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        max-width: 300px;
        margin: 0 auto;
      }
      
      .keypad-grid .btn {
        height: 60px;
        font-size: 20px;
        font-weight: bold;
      }
      
      .keypad-grid .btn:nth-child(10) {
        grid-column: 2;
        grid-row: 4;
      }
      
      .keypad-grid .btn:nth-child(11) {
        grid-column: 1;
        grid-row: 4;
      }
      
      .keypad-grid .btn:nth-child(12) {
        grid-column: 3;
        grid-row: 4;
      }
      
      /* Garantir que elementos ocultos não ocupem espaço */
      .hidden-element {
        display: none !important;
      }
      
      /* Layout em tela cheia */
      .fullscreen-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
      }
      
      .keypad-fullscreen {
        background-color: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .iframe-fullscreen {
        background-color: white;
      }
    </style>
  </head>
  <body class="d-flex flex-column min-vh-100">
    <!-- Header -->
    <header
      class="bg-white border-bottom shadow-sm"
      id="headerContainer"
      style="display: none"
    >
      <div class="container-fluid">
        <div class="row align-items-center py-3">
          <div class="col-2">
            <button
              class="btn btn-primary btn-sm"
              id="backButton"
              onclick="voltarParaTeclado()"
            >
              ← Voltar
            </button>
          </div>
          <div class="col-10">
            
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow-1 position-relative">
      <!-- Teclado -->
      <div
        class="fullscreen-container keypad-fullscreen"
        id="keypadContainer"
      >
        <div class="container">
          <div class="row justify-content-center">
            <div class="col-md-6 col-lg-4">
              <div class="card shadow">
                <div class="card-body p-4">
                  <h1 class="h3 text-center mb-4 fw-bold">
                    Informe o Contrato
                  </h1>

                  <input
                    type="text"
                    id="contractInput"
                    class="form-control form-control-lg text-center mb-4"
                    placeholder="Digite o número do contrato"
                  />

                  <div class="keypad-grid">
                    <button class="btn btn-primary" onclick="addDigit('7')">
                      7
                    </button>
                    <button class="btn btn-primary" onclick="addDigit('8')">
                      8
                    </button>
                    <button class="btn btn-primary" onclick="addDigit('9')">
                      9
                    </button>
                    <button class="btn btn-primary" onclick="addDigit('4')">
                      4
                    </button>
                    <button class="btn btn-primary" onclick="addDigit('5')">
                      5
                    </button>
                    <button class="btn btn-primary" onclick="addDigit('6')">
                      6
                    </button>
                    <button class="btn btn-primary" onclick="addDigit('1')">
                      1
                    </button>
                    <button class="btn btn-primary" onclick="addDigit('2')">
                      2
                    </button>
                    <button class="btn btn-primary" onclick="addDigit('3')">
                      3
                    </button>
                    <button class="btn btn-primary" onclick="addDigit('0')">
                      0
                    </button>
                    <button class="btn btn-warning" onclick="removeDigit()">
                      ←
                    </button>
                    <button class="btn btn-success" onclick="onConfirm()">
                      ✓
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Iframe -->
      <div class="fullscreen-container iframe-fullscreen" id="iframeContainer" style="display: none">
        <iframe id="testIframe" src="" class="w-100 h-100 border-0"></iframe>
      </div>
    </main>

    <!-- Footer -->
    <footer
      class="bg-white border-top shadow-sm"
      id="footerContainer"
      style="display: none"
    >
      <div class="container-fluid">
        <div class="row justify-content-center py-3">
          <div class="col-auto">
            <button class="btn btn-danger" id="exitButton" onclick="sair()">
              X Sair
            </button>
          </div>
        </div>
      </div>
    </footer>

    <!-- Bootstrap 5 JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let sessionToken = undefined;
      // URL base da aplicação
      //const BASE_URL = "https://totem-bemobi-web.vercel.app";
      const BASE_URL = "http://localhost:3000";

      // Variável para armazenar o número do contrato
      let contractNumber = "";

      // Funções para manipulação de cookies
      function setCookie(name, value, days = 30) {
        const expires = new Date();
        expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
        document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Strict`;
      }

      function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(";");
        for (let i = 0; i < ca.length; i++) {
          let c = ca[i];
          while (c.charAt(0) === " ") c = c.substring(1, c.length);
          if (c.indexOf(nameEQ) === 0)
            return c.substring(nameEQ.length, c.length);
        }
        return null;
      }

      function deleteCookie(name) {
        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;SameSite=Strict`;
      }

      // Função para adicionar dígito ao campo
      function addDigit(digit) {
        const input = document.getElementById("contractInput");
        input.value += digit;
      }

      // Função para remover último dígito
      function removeDigit() {
        const input = document.getElementById("contractInput");
        input.value = input.value.slice(0, -1);
      }

      // Função para voltar ao teclado
      function voltarParaTeclado() {
        // Ocultar o iframe, header e footer
        document.getElementById("iframeContainer").style.display = "none";
        document.getElementById("headerContainer").style.display = "none";
        document.getElementById("footerContainer").style.display = "none";

        // Mostrar o teclado
        document
          .getElementById("keypadContainer")
          .classList.remove("hidden-element");

        // Limpar o campo de entrada e focar
        const input = document.getElementById("contractInput");
        input.value = "";
        input.focus();

        console.log("Retornando ao teclado");
      }

      // Função para sair (recarregar página)
      function sair() {
        console.log("Saindo do sistema...");
        window.location.reload();
      }

      // Função de confirmação
      function onConfirm() {
        contractNumber = document.getElementById("contractInput").value;

        if (contractNumber.trim() === "") {
          alert("Por favor, digite um número de contrato.");
          return;
        }

        console.log("Número do contrato confirmado:", contractNumber);

        // Ocultar o teclado e mostrar o header, footer e iframe
        document
          .getElementById("keypadContainer")
          .classList.add("hidden-element");
        document.getElementById("headerContainer").style.display = "block";
        document.getElementById("footerContainer").style.display = "block";
        document.getElementById("iframeContainer").style.display = "block";

        // Garantir que os botões voltar e sair estejam visíveis
        document.getElementById("backButton").style.display = "flex";
        document.getElementById("exitButton").style.display = "flex";

        // Inicializar o iframe com a URL correta baseada no sessionToken
        if (sessionToken) {
          // Se o sessionToken existe, redirecionar para a URL com o token
          document.getElementById("testIframe").src =
            BASE_URL + "/bemobi/" + sessionToken + "/light";
          console.log(
            "Redirecionando para checkout com sessionToken:",
            BASE_URL + "/bemobi/" + sessionToken + "/light"
          );
        } else {
          // Se não existe sessionToken, redirecionar para ativação
          document.getElementById("testIframe").src =
            BASE_URL + "/activation/serial";
          console.log(
            "Redirecionando para ativação:",
            BASE_URL + "/activation/serial"
          );
        }
      }

      // Função para enviar dados para listagem
      function enviarDadosParaListagem() {
        const iframe = document.querySelector("iframe");
        const mensagem = {
          event: "SELECTED_INVOICES",
          ids: [""],
          documentNumber: "01205793321",
          installationCode: contractNumber,
          contractCode: contractNumber,
          protocol: "20251003000001",
        };
        iframe.contentWindow.postMessage(mensagem, "*");
      }

      // Listener para receber mensagens do iframe
      window.onmessage = function (e) {
        if (e.origin === BASE_URL) {
          console.log("Mensagem recebida no iframe:", e.data);
        }
        if (e.data.event != undefined) {
          /*
           * Ao receber a mensagem DEVICE_ACTIVATION_OK, será recebido o Session Token, que deve ser armazenado em um cookie do navegador
           * ou em algum outro local para ser utilizado nas próximas requisições. Renove-o com frequencia para que não expire.
           * Caso seja perdido, será necessário ativar novamente o dispositivo.
           */
          if (e.data.event == "DEVICE_ACTIVATION_OK") {
            console.log(
              "Dispositivo ativado com sucesso. Session Token: ",
              e.data.sessionToken
            );

            // Salvar o sessionToken em um cookie
            if (e.data.sessionToken) {
              setCookie("sessionToken", e.data.sessionToken, 30); // Cookie válido por 30 dias
              console.log("Session Token salvo em cookie com sucesso!");
              document.getElementById("testIframe").src =
                BASE_URL + "/bemobi/" + e.data.sessionToken + "/device";
            } else {
              console.warn(
                "Session Token não foi recebido na mensagem DEVICE_ACTIVATION_OK"
              );
            }
          }

          /*
           * Ao receber a mensagem DEVICE_ACTIVATION_FAILED, o sessionToken deve ser removido do cookie
           * pois a ativação falhou e o token não é mais válido.
           */
          if (e.data.event == "DEVICE_ACTIVATION_FAILED") {
            console.log(
              "Falha na ativação do dispositivo. Removendo sessionToken do cookie."
            );
            deleteCookie("sessionToken");
            console.log("Session Token removido do cookie com sucesso!");
          }

          /*
           * Ao receber a mensagem SITEF_ISSUE_RESOLUTION_OK, a aplicação pode capturar os dados que achar necessário,
           * direcionando para o checkout Bemobi quando entender necessário.
           */
          if (e.data.event == "SITEF_ISSUE_RESOLUTION_OK") {
            // Ocultar o iframe, header e footer, mostrar o teclado
            document.getElementById("iframeContainer").style.display = "none";
            document.getElementById("headerContainer").style.display = "none";
            document.getElementById("footerContainer").style.display = "none";
            document
              .getElementById("keypadContainer")
              .classList.remove("hidden-element");

            // Focar no campo de entrada
            document.getElementById("contractInput").focus();
          }
          /*
           * Aguarde este evento para enviar a mensagem com os dados da conta selecionada para consulta.
           */
          if (e.data.event == "PAGE_LOADED") {
            setTimeout(enviarDadosParaListagem, 1000); // Aguarda 1 segundo para garantir que o iframe carregou
            document.getElementById("backButton").style.display = "flex";
            document.getElementById("exitButton").style.display = "flex";
          }

          /*
           * Quando este evento for enviado, a aplicação host deve remover qualquer ação que um usuário possa usar para sair da tela.
           * Deve aguardar o evento PAYMENT_SUCCESS ou PAYMENT_ERROR para liberar tais ações novamente.
           */
          if (e.data.event == "PAYMENT_IN_PROGRESS") {
            console.log("Pagamento em andamento...");
            // Esconder o botão voltar e sair durante o pagamento
            document.getElementById("backButton").style.display = "none";
            document.getElementById("exitButton").style.display = "none";
          }

          /*
           * Ao receber este evento, a aplicação host pode liberar as ações que um usuário poderia usar para sair da tela.
           * O pagamento foi finalizado com sucesso, com as informações da transação disponíveis no objeto transaction.
           */
          if (e.data.event == "PAYMENT_OK") {
            console.log(
              "Pagamento finalizado com sucesso!!! Dados da transação: ",
              e.data.transaction
            );
            // Mostrar os botões voltar e sair novamente
            document.getElementById("backButton").style.display = "flex";
            document.getElementById("exitButton").style.display = "flex";
          }

          /*
           * Ao receber este evento, a aplicação host pode liberar as ações que um usuário poderia usar para sair da tela.
           * O pagamento ainda poderá ser retentado dentro do IFrame
           * O pagamento foi finalizado com falha na transação.
           */
          if (e.data.event == "PAYMENT_ERROR") {
            console.log(
              "Pagamento finalizado com falha na transação. Dados da transação: ",
              e.data.error
            );
            // Mostrar os botões voltar e sair novamente
            document.getElementById("backButton").style.display = "flex";
            document.getElementById("exitButton").style.display = "flex";
            //document.getElementById("testIframe").src = BASE_URL + "/bemobi/" + sessionToken + "/light";;
          }

          /*
           * Ao receber este evento, a aplicação host pode liberar as ações que um usuário poderia usar para sair da tela.
           * O pagamento foi finalizado com falha na transação.
           */
          if (e.data.event == "PAYMENT_CANCELLED") {
            console.log("Pagamento Cancelado: ", e.data.error);
            // Mostrar os botões voltar e sair novamente
            document.getElementById("backButton").style.display = "flex";
            document.getElementById("exitButton").style.display = "flex";
            document.getElementById("testIframe").src =
              BASE_URL + "/bemobi/" + sessionToken + "/device";
          }

          /*
           * Ao receber este evento, a aplicação host deverá retornar à tela inicial.
           */
          if (e.data.event == "PAYMENT_TIMEOUT") {
            // Mostrar os botões voltar e sair novamente
            document.getElementById("backButton").style.display = "flex";
            document.getElementById("exitButton").style.display = "flex";
            document.getElementById("testIframe").src =
              BASE_URL + "/bemobi/" + sessionToken + "/device";
          }
        }
      };

      // Permitir entrada via teclado e colagem
      document
        .getElementById("contractInput")
        .addEventListener("keydown", function (e) {
          // Permitir Ctrl+V (colar) e teclas de controle
          if (e.ctrlKey && e.key === "v") {
            return; // Permitir colagem
          }

          // Permitir apenas números e teclas de controle
          if (
            !/[0-9]/.test(e.key) &&
            !["Backspace", "Delete", "ArrowLeft", "ArrowRight", "Tab"].includes(
              e.key
            )
          ) {
            e.preventDefault();
          }
        });

      // Permitir colagem via Ctrl+V
      document
        .getElementById("contractInput")
        .addEventListener("paste", function (e) {
          e.preventDefault();
          const paste = (e.clipboardData || window.clipboardData).getData(
            "text"
          );

          // Filtrar apenas números da string colada
          const numbersOnly = paste.replace(/[^0-9]/g, "");

          // Adicionar os números ao campo
          const input = document.getElementById("contractInput");
          input.value += numbersOnly;
        });

      // Inicializar quando a página carregar
      window.onload = function () {
        sessionToken = getCookie("sessionToken");
        console.log(
          "Página carregada. Session Token:",
          sessionToken ? "encontrado" : "não encontrado"
        );

        // Focar no campo de entrada do contrato
        document.getElementById("contractInput").focus();
      };
    </script>
  </body>
</html>
