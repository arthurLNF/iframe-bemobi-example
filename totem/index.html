<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Informe o Contrato</title>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      /* Reset b√°sico para garantir tela cheia */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      /* Apenas estilos m√≠nimos necess√°rios */
      .keypad-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        max-width: 300px;
        margin: 0 auto;
      }

      .keypad-grid .btn {
        height: 60px;
        font-size: 20px;
        font-weight: bold;
      }

      .keypad-grid .btn:nth-child(10) {
        grid-column: 2;
        grid-row: 4;
      }

      .keypad-grid .btn:nth-child(11) {
        grid-column: 1;
        grid-row: 4;
      }

      .keypad-grid .btn:nth-child(12) {
        grid-column: 3;
        grid-row: 4;
      }

      /* Garantir que elementos ocultos n√£o ocupem espa√ßo */
      .hidden-element {
        display: none !important;
      }

      /* Layout em tela cheia */
      .fullscreen-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100vw;
        height: 100vh;
        margin: 0;
        padding: 0;
        z-index: 1000;
      }

      .keypad-fullscreen {
        background-color: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .iframe-fullscreen {
        background-color: white;
      }

      /* Garantir que o iframe ocupe toda a tela */
      #testIframe {
        width: 100vw !important;
        height: 100vh !important;
        border: none !important;
        margin: 0 !important;
        padding: 0 !important;
        display: block !important;
      }
    </style>
  </head>
  <body class="d-flex flex-column min-vh-100">
    <!-- Header -->
    <header
      class="bg-white border-bottom shadow-sm"
      id="headerContainer"
      style="display: none"
    >
      <div class="container-fluid">
        <div class="row align-items-center py-3">
          <div class="col-2">
            <button
              class="btn btn-primary btn-sm"
              id="backButton"
              onclick="voltarParaTeclado()"
              style="visibility: hidden"
            >
              ‚Üê Voltar
            </button>
          </div>
          <div class="col-10">
            <!-- T√≠tulo removido -->
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow-1 position-relative">
      <!-- Teclado -->
      <div class="fullscreen-container keypad-fullscreen" id="keypadContainer">
        <div class="container">
          <div class="row justify-content-center">
            <div class="col-md-6 col-lg-4">
              <div class="card shadow">
                <div class="card-body p-4">
                  <h1 class="h3 text-center mb-4 fw-bold">
                    Informe o Contrato
                  </h1>

                  <input
                    type="text"
                    id="contractInput"
                    class="form-control form-control-lg text-center mb-4"
                    placeholder="Digite o n√∫mero do contrato"
                  />

                  <div class="keypad-grid">
                    <button class="btn btn-primary" onclick="addDigit('7')">
                      7
                    </button>
                    <button class="btn btn-primary" onclick="addDigit('8')">
                      8
                    </button>
                    <button class="btn btn-primary" onclick="addDigit('9')">
                      9
                    </button>
                    <button class="btn btn-primary" onclick="addDigit('4')">
                      4
                    </button>
                    <button class="btn btn-primary" onclick="addDigit('5')">
                      5
                    </button>
                    <button class="btn btn-primary" onclick="addDigit('6')">
                      6
                    </button>
                    <button class="btn btn-primary" onclick="addDigit('1')">
                      1
                    </button>
                    <button class="btn btn-primary" onclick="addDigit('2')">
                      2
                    </button>
                    <button class="btn btn-primary" onclick="addDigit('3')">
                      3
                    </button>
                    <button class="btn btn-primary" onclick="addDigit('0')">
                      0
                    </button>
                    <button class="btn btn-warning" onclick="removeDigit()">
                      ‚Üê
                    </button>
                    <button class="btn btn-success" onclick="onConfirm()">
                      ‚úì
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Iframe -->
      <div
        class="fullscreen-container iframe-fullscreen"
        id="iframeContainer"
        style="display: none"
      >
        <iframe
          id="testIframe"
          src=""
          class="w-100 h-100 border-0"
          allow="local-network-access"
        ></iframe>
      </div>
    </main>

    <!-- Footer -->
    <footer
      class="bg-white border-top shadow-sm"
      id="footerContainer"
      style="display: none"
    >
      <div class="container-fluid">
        <div class="row justify-content-center py-3">
          <div class="col-auto">
            <button
              class="btn btn-danger"
              id="exitButton"
              onclick="sair()"
              style="visibility: hidden"
            >
              üö™ Sair
            </button>
          </div>
        </div>
      </div>
    </footer>

    <!-- Bootstrap 5 JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let sessionToken = undefined;
      // URL base da aplica√ß√£o
      //const BASE_URL = "https://totem-bemobi-web.vercel.app";
      const BASE_URL = "http://localhost:3000";

      // Vari√°vel para armazenar o n√∫mero do contrato
      let contractNumber = "";

      // Fun√ß√µes para manipula√ß√£o de cookies
      function setCookie(name, value, days = 30) {
        const expires = new Date();
        expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
        document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Strict`;
      }

      function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(";");
        for (let i = 0; i < ca.length; i++) {
          let c = ca[i];
          while (c.charAt(0) === " ") c = c.substring(1, c.length);
          if (c.indexOf(nameEQ) === 0)
            return c.substring(nameEQ.length, c.length);
        }
        return null;
      }

      function deleteCookie(name) {
        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;SameSite=Strict`;
      }

      // Fun√ß√£o para adicionar d√≠gito ao campo
      function addDigit(digit) {
        const input = document.getElementById("contractInput");
        input.value += digit;
      }

      // Fun√ß√£o para remover √∫ltimo d√≠gito
      function removeDigit() {
        const input = document.getElementById("contractInput");
        input.value = input.value.slice(0, -1);
      }

      // Fun√ß√£o para voltar ao teclado
      function voltarParaTeclado() {
        // Mostrar apenas o teclado
        displayElements(true, false, false, false);

        // Limpar o campo de entrada e focar
        const input = document.getElementById("contractInput");
        input.value = "";
        input.focus();

        console.log("Retornando ao teclado");
      }

      // Fun√ß√£o para sair (recarregar p√°gina)
      function sair() {
        console.log("Saindo do sistema...");
        window.location.reload();
      }

      // Fun√ß√£o centralizada para controlar visibilidade dos bot√µes
      function displayButtons(displayStatus) {
        const backButton = document.getElementById("backButton");
        const exitButton = document.getElementById("exitButton");

        if (backButton && exitButton) {
          if (
            displayStatus === true ||
            displayStatus === "show" ||
            displayStatus === "visible"
          ) {
            backButton.style.visibility = "hidden";
            exitButton.style.visibility = "visible";
            console.log("Bot√µes exibidos");
          } else if (
            displayStatus === false ||
            displayStatus === "hide" ||
            displayStatus === "hidden"
          ) {
            backButton.style.visibility = "hidden";
            exitButton.style.visibility = "hidden";
            console.log("Bot√µes ocultados");
          } else {
            console.warn(
              "displayButtons: Status inv√°lido. Use true/false, 'show'/'hide', ou 'visible'/'hidden'"
            );
          }
        } else {
          console.error("displayButtons: Bot√µes n√£o encontrados no DOM");
        }
      }

      // Fun√ß√£o para controlar visibilidade dos elementos principais
      function displayElements(keypad, header, footer, iframe) {
        const keypadContainer = document.getElementById("keypadContainer");
        const headerContainer = document.getElementById("headerContainer");
        const footerContainer = document.getElementById("footerContainer");
        const iframeContainer = document.getElementById("iframeContainer");

        // Controlar teclado
        if (keypad === true || keypad === "show" || keypad === "visible") {
          keypadContainer.classList.remove("hidden-element");
        } else if (
          keypad === false ||
          keypad === "hide" ||
          keypad === "hidden"
        ) {
          keypadContainer.classList.add("hidden-element");
        }

        // Controlar header
        if (header === true || header === "show" || header === "visible") {
          headerContainer.style.display = "block";
        } else if (
          header === false ||
          header === "hide" ||
          header === "hidden"
        ) {
          headerContainer.style.display = "none";
        }

        // Controlar footer
        if (footer === true || footer === "show" || footer === "visible") {
          footerContainer.style.display = "block";
        } else if (
          footer === false ||
          footer === "hide" ||
          footer === "hidden"
        ) {
          footerContainer.style.display = "none";
        }
        headerContainer.style.display = "none";
        footerContainer.style.display = "none";
        // Controlar iframe
        if (iframe === true || iframe === "show" || iframe === "visible") {
          iframeContainer.style.display = "block";
        } else if (
          iframe === false ||
          iframe === "hide" ||
          iframe === "hidden"
        ) {
          iframeContainer.style.display = "none";
        }

        console.log(
          `Elementos: teclado=${keypad}, header=${header}, footer=${footer}, iframe=${iframe}`
        );
      }

      // Fun√ß√£o de confirma√ß√£o
      function onConfirm() {
        contractNumber = document.getElementById("contractInput").value;
        document.getElementById("contractInput").value = "";
        if (contractNumber.trim() === "") {
          alert("Por favor, digite um n√∫mero de contrato.");
          return;
        }

        console.log("N√∫mero do contrato confirmado:", contractNumber);

        // Ocultar o teclado e mostrar o header, footer e iframe
        displayElements(false, true, true, true);
        displayButtons(true);

        // Inicializar o iframe com a URL correta baseada no sessionToken
        if (sessionToken) {
          // Se o sessionToken existe, redirecionar para a URL com o token
          document.getElementById("testIframe").src =
            BASE_URL + "/bemobi/" + sessionToken + "/light";
          console.log(
            "Redirecionando para checkout com sessionToken:",
            BASE_URL + "/bemobi/" + sessionToken + "/light"
          );
        } else {
          // Se n√£o existe sessionToken, redirecionar para ativa√ß√£o
          document.getElementById("testIframe").src =
            BASE_URL + "/activation/serial";
          console.log(
            "Redirecionando para ativa√ß√£o:",
            BASE_URL + "/activation/serial"
          );
        }
      }

      // Fun√ß√£o para enviar dados para listagem
      function enviarDadosParaListagem() {
        const iframe = document.querySelector("iframe");
        const mensagem = {
          event: "SELECTED_INVOICES",
          ids: ["561310138305"],
          documentNumber: "01205793321",
          installationCode: contractNumber,
          contractCode: "3019024597", //contractNumber,
          protocol: "6904422F0A14561CE10000000A034F96",
          protocol2: "3637655199",
          partnerNumber: "0031965321",
        };
        iframe.contentWindow.postMessage(mensagem, "*");
      }

      // Listener para receber mensagens do iframe
      window.onmessage = function (e) {
        if (e.origin === BASE_URL) {
          console.log("Mensagem recebida no iframe:", e.data);
        }
        if (e.data.event != undefined) {
          /*
           * Ao receber a mensagem DEVICE_ACTIVATION_OK, ser√° recebido o Session Token, que deve ser armazenado em um cookie do navegador
           * ou em algum outro local para ser utilizado nas pr√≥ximas requisi√ß√µes.
           * Caso seja perdido, ser√° necess√°rio ativar novamente o dispositivo.
           */
          if (e.data.event == "DEVICE_ACTIVATION_OK") {
            console.log(
              "Dispositivo ativado com sucesso. Session Token: ",
              e.data.sessionToken
            );

            // Salvar o sessionToken em um cookie
            if (e.data.sessionToken) {
              setCookie("sessionToken", e.data.sessionToken, 30); // Cookie v√°lido por 30 dias
              sessionToken = e.data.sessionToken; // Atualizar vari√°vel global
              console.log("Session Token salvo em cookie com sucesso!");

              // Mostrar teclado para digita√ß√£o de contrato
              displayElements(true, false, false, false);
            } else {
              console.warn(
                "Session Token n√£o foi recebido na mensagem DEVICE_ACTIVATION_OK"
              );
            }
          }

          /*
           * Ao receber a mensagem DEVICE_ACTIVATION_REQUEST, nada √© necess√°rio fazer, apenas aguardar a ativa√ß√£o do dispositivo.
           * Pode-se usar este evento para enviar uma notifica√ß√£o para o suporte, informando que o dispositivo precisa ser ativado.
           */
          if (e.data.event == "DEVICE_ACTIVATION_REQUEST") {
            console.log(
              "Requisi√ß√£o de ativa√ß√£o de dispositivo recebida:",
              e.data
            );
          }

          /*
           * Ao receber a mensagem DEVICE_ACTIVATION_FAILED, o sessionToken deve ser removido do cookie
           * pois a ativa√ß√£o falhou e o token n√£o √© mais v√°lido.
           */
          if (e.data.event == "DEVICE_ACTIVATION_FAILED") {
            console.log(
              "Falha na ativa√ß√£o do dispositivo. Recarregando p√°gina."
            );
            deleteCookie("sessionToken");
            sessionToken = undefined; // Limpar vari√°vel global
            console.log("Session Token removido do cookie com sucesso!");

            // Recarregar a p√°gina
            window.location.reload();
          }

          /*
           * Ao receber a mensagem SITEF_ISSUE_RESOLUTION_OK, a aplica√ß√£o pode capturar os dados que achar necess√°rio,
           * direcionando para o checkout Bemobi quando entender necess√°rio.
           */
          if (e.data.event == "SITEF_ISSUE_RESOLUTION_OK") {
            // Mostrar apenas o teclado
            displayElements(true, false, false, false);

            // Focar no campo de entrada
            document.getElementById("contractInput").focus();
          }
          /*
           * Aguarde este evento para enviar a mensagem com os dados da conta selecionada para consulta.
           */
          if (e.data.event == "PAGE_LOADED") {
            setTimeout(enviarDadosParaListagem, 1000); // Aguarda 1 segundo para garantir que o iframe carregou
            displayButtons(true);
          }

          /*
           * Quando este evento for enviado, a aplica√ß√£o host deve remover qualquer a√ß√£o que um usu√°rio possa usar para sair da tela.
           * Deve aguardar o evento PAYMENT_SUCCESS ou PAYMENT_ERROR para liberar tais a√ß√µes novamente.
           */
          if (e.data.event == "PAYMENT_IN_PROGRESS") {
            console.log("Pagamento em andamento...");
            // Esconder o bot√£o voltar e sair durante o pagamento
            displayButtons(false);
          }

          /*
           * Ao receber este evento, a aplica√ß√£o host pode liberar as a√ß√µes que um usu√°rio poderia usar para sair da tela.
           * O pagamento foi finalizado com sucesso, com as informa√ß√µes da transa√ß√£o dispon√≠veis no objeto transaction.
           */
          if (e.data.event == "PAYMENT_OK") {
            console.log(
              "Pagamento finalizado com sucesso!!! Dados da transa√ß√£o: ",
              e.data.transaction
            );
            // Mostrar os bot√µes voltar e sair novamente
            displayButtons(true);
          }

          /*
           * Ao receber este evento, a aplica√ß√£o host pode liberar as a√ß√µes que um usu√°rio poderia usar para sair da tela.
           * O pagamento ainda poder√° ser retentado dentro do IFrame
           * O pagamento foi finalizado com falha na transa√ß√£o.
           */
          if (e.data.event == "PAYMENT_ERROR") {
            console.log(
              "Pagamento finalizado com falha na transa√ß√£o. Dados da transa√ß√£o: ",
              e.data.error
            );
            // Mostrar os bot√µes voltar e sair novamente
            displayButtons(true);
            //document.getElementById("testIframe").src = BASE_URL + "/bemobi/" + sessionToken + "/light";;
          }

          /*
           * Ao receber este evento, a aplica√ß√£o host pode liberar as a√ß√µes que um usu√°rio poderia usar para sair da tela.
           * O pagamento foi finalizado com falha na transa√ß√£o.
           */
          if (e.data.event == "PAYMENT_CANCELLED") {
            //console.log("Pagamento Cancelado: ", e.data.error, e.data.transaction);
            // Mostrar os bot√µes voltar e sair novamente
            displayButtons(true);
            window.location.reload();
          }

          if (e.data.event == "PAYMENT_GO_BACK") {
            //console.log("Voltou do pagamento: ", e.data.error, e.data.transaction);
            // Mostrar os bot√µes voltar e sair novamente
            displayButtons(true);
            window.location.reload();
          }

          /*
           * Ao receber este evento, a aplica√ß√£o host dever√° retornar √† tela inicial.
           */
          if (e.data.event == "PAYMENT_TIMEOUT") {
            //console.log("Pagamento Timeout");
            // Mostrar os bot√µes voltar e sair novamente
            displayButtons(true);
            window.location.reload();
          }
        }
      };

      // Permitir entrada via teclado e colagem
      document
        .getElementById("contractInput")
        .addEventListener("keydown", function (e) {
          // Permitir Ctrl+V (colar) e teclas de controle
          if (e.ctrlKey && e.key === "v") {
            return; // Permitir colagem
          }

          // Permitir apenas n√∫meros e teclas de controle
          if (
            !/[0-9]/.test(e.key) &&
            !["Backspace", "Delete", "ArrowLeft", "ArrowRight", "Tab"].includes(
              e.key
            )
          ) {
            e.preventDefault();
          }
        });

      // Permitir colagem via Ctrl+V
      document
        .getElementById("contractInput")
        .addEventListener("paste", function (e) {
          e.preventDefault();
          const paste = (e.clipboardData || window.clipboardData).getData(
            "text"
          );

          // Filtrar apenas n√∫meros da string colada
          const numbersOnly = paste.replace(/[^0-9]/g, "");

          // Adicionar os n√∫meros ao campo
          const input = document.getElementById("contractInput");
          input.value += numbersOnly;
        });

      // Inicializar quando a p√°gina carregar
      window.onload = function () {
        sessionToken = getCookie("sessionToken");
        console.log(
          "P√°gina carregada. Session Token:",
          sessionToken ? "encontrado" : "n√£o encontrado"
        );

        // Novo fluxo: verificar sessionToken
        if (sessionToken) {
          // Com sessionToken: mostrar iframe para device
          console.log(
            "Iniciando com sessionToken - redirecionando para device"
          );
          displayElements(false, false, false, true);
          document.getElementById("testIframe").src =
            BASE_URL + "/bemobi/" + sessionToken + "/device";
        } else {
          // Sem sessionToken: mostrar iframe para ativa√ß√£o
          console.log(
            "Iniciando sem sessionToken - redirecionando para ativa√ß√£o"
          );
          displayElements(false, false, false, true);
          document.getElementById("testIframe").src =
            BASE_URL + "/activation/serial";
        }
      };
    </script>
  </body>
</html>
